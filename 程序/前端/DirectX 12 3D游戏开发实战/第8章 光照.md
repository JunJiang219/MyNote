# 8.1 光照与材质的交互
在开启光照的同时，我们不再直接指出顶点的颜色，而是指定材质与光照，再运用光照方程（ lighting equation ）基于两者的交互来计算顶点颜色。这样做会使物体的颜色更趋于真实。

我们可以把材质看作是确定光照与物体表面如何进行交互的属性集。此属性集中的属性有：**==表面反射光==** 和 **==可吸收光的颜色==**、**==表面下材质的折射率==**、**==表面的光滑度==** 以及 **==表面的透明度==**。

当光线从光源发出向外传播并触碰到某个物体时，**==一部分光线可能会被吸收==**，而 **==另一部分光线则将被反射==**（ 对于玻璃这类透明物体，**==部分光线能透过介质==**（medium，也作媒介），但我们暂不考虑这种情况 ）。被反射的光线会沿着它的新路径传播，并有可能再次碰到其他物体，发生二次吸收与反射。因此，会发生这样一种情况，那就是光线在碰到足够多的物体后被完全吸收了。而一些剩余的光线最终可能会传入观察者的眼中并照射到视网膜上感光细胞。

根据 **==三色论（ trichromatic theory，又称三色说 ）==**，视网膜含有 3 种光受体，分别对红、绿、蓝三色光敏感（ 有部分重叠 ）。RGB 入射光刺激其相应的光受体，基于光线的强度而产生不同程度的刺激。

# 8.2 法向量
![[./assets/Pasted image 20240814131046.png]]
![[./assets/Pasted image 20240814132116.png]]

## 8.2.1 计算法向量
![[./assets/Pasted image 20240814135618.png]]
![[./assets/Pasted image 20240814135655.png]]

## 8.2.2 变换法向量
![[./assets/Pasted image 20240814143535.png]]
![[./assets/Pasted image 20240814143559.png]]
![[./assets/Pasted image 20240814144147.png]]

> [!NOTE] 注意
> 尽管运用了逆转置变换，但法向量仍可能失去其长度。所以在变换完成后，可能需对它再次进行规范化处理。


# 8.3 参与光照计算的一些关键向量
![[./assets/Pasted image 20240814151323.png]]
![[./assets/Pasted image 20240814151336.png]]

# 8.4 朗伯余弦定理
我们可以将光看做是光子的集合，在空间中按特定的方向传播。每个光子都载有（光）能量。光源每秒发出的（光）能量称为 **==辐射通量（radiant flux）==**。而单位面积上的辐射通量密度（irradiance，称为 **==辐（射）照度==**）是一种很重要的概念，因为我们将用它来确定表面某区域接收到的光量（即眼睛感受到的明亮度）。
![[./assets/Pasted image 20240814195749.png]]

换句话说，面积 $A_2$ 内的辐照度就相当于将受垂直方向光照的面积 $A_1$ 内的辐照度按比例 $n \cdot L = cos\theta$ 进行缩放。这就是传说中的 **==朗伯余弦定理（Lambert's Cosine Law）==**。考虑到光线照射到表面另一侧的情况（此时，点积的结果为负值），我们用 max 函数来钳制 “缩放因子” 的取值范围：
$$
f(\theta) = max(cos\theta, 0) = max(L \cdot n, 0)
$$
图 8.11 所示的是函数 $f(\theta)$ 的图像。观察可知，随着变量 $\theta$ 的变化，函数的值域范围为 0.0~1.0（即光照强度的变化范围为 0%~100%）。
![[./assets/Pasted image 20240814201127.png]]
![[./assets/Pasted image 20240814201313.png]]

# 8.5 漫反射光照
考虑图 8.12 所示的不透明物体表面。当光线照射到表面上某一点时，一部分光会进入物体的内部，并与表面附近的物质相互作用。这些光会在物体内部四处反弹，==一部分被吸收，余下部分则会向各个方向散射并返回表面==，这就是所谓的 **==漫反射（diffuse reflection）==**。
![[./assets/Pasted image 20240826181240.png]]

我们将漫反射光照的计算分为两个部分。在第一部分中，我们要指定光照颜色以及 **==漫反射反照率==**（diffuse albedo）颜色。漫反射反照率表示的是根据表面的 **==漫反射率==**（diffuse reflectance，也译作漫反射比）而被反射的入射光量。要对它们进行处理就需要分量式颜色乘法。例如，假设表面上一点会反射 50% 的入射红光、100% 的绿光和 75% 的蓝光，如果这时有一束强度为 80% 的白光袭来，那么此入射光的量值就可以表示为 $B_L = (0.8, 0.8, 0.8)$ ，又因为漫反射反照率为 $m_d = (0.5, 1.0, 0.75)$ ，所以此点的反射光量为：
$$
c_d = B_L \otimes m_d = (0.8, 0.8, 0.8) \otimes (0.5, 1.0, 0.75) = (0.4, 0.8, 0.6)
$$
然而，上述公式并非十分准确，我们还需将朗伯余弦定律（根据表面向量与光向量夹角来控制表面接收原始光照的量）考虑在内。设 $B_L$ 表示入射光量， $m_d$ 为漫反射反照率，$L$ 为光向量，$n$ 为表面法线，则位于表面上某点处的漫反射光量为：
$$
c_d = max(L \cdot n, 0) \cdot B_L \otimes m_d
$$

# 8.6 环境光照
如前文所述，我们的光照模型并没有考虑到场景中其他物体反射来的间接光照。为了处理这种间接光照，我们给光照方程引进了一个 ==**环境光**==（ambient light）项：
$$
c_a = A_L \otimes m_d
$$
颜色 $A_L$ 指定了表面接收到的间接（环境）光量，$m_d$ 为漫反射反照率。

# 8.7 镜面光照
第二种反射的发生是根据一种名为 **==菲涅尔效应==**（Fresnel effect）的物理现象。当光线到达两种不同 **==折射率==**（index of refraction）介质之间的界面时，一部分光将被反射，而剩下的光则发生 **==折射==**（refract），**==折射率==** 是一种介质的物理性质，即 ==光在真空中传播的速度与光在给定介质内的传播速度之比== 。我们将第二种光的反射过程称为 ==**镜面反射**==（specular reflection），把被反射的光称为 **==镜面（反射）光==**（specular light）。
![[./assets/Pasted image 20240826201747.png]]
![[./assets/Pasted image 20240826201837.png]]

如果折射光沿折射向量从介质的另一侧射出，并进入观察者眼中，则该物体看起来就像是透明的。即光通过了透明的物体。在实时的图像处理中，一般用 alpha 混合技术或后期处理特效来模拟透明对象的折射过程。
与漫反射相比，镜面光可能并不会摄入观察者的眼内，因为其反射只发生在某一特定角度。也就是说，镜面光的计算与观察点有关。同时，这就意味着随着观察位置在场景中移动，它所收到的镜面光量也随之变化。

## 8.7.1 菲涅尔效应
我们来考虑一个具有发现 n 的平滑界面，它将两种不同折射率的介质分隔开来。**==菲涅尔方程==**（Fresnel equations）以数学方法描述了入射光线被反射的百分比，即 $0 \leq R_F \leq 1$ 。根据能量守恒定律，如果 $R_F$ 是反射光量，则 $(1 - R_F)$ 为折射光量。$R_F$ 的值是一个 RGB 向量，因为光的颜色反映了反射光量。
反射的光量即依赖于介质，也与法向量 n 与光向量 L 之间的夹角 $\theta_i$ 有关。由于光照过程的复杂性，我们一般不会将完整的菲涅尔方程用于实时渲染，而是采用 **==石里克近似==**（Schlick approximation）法来加以代替：
$$
R_F(\theta_i) = R_F(0^o) + (1 - R_F(0^o))(1 - \cos\theta_i)^5
$$
$R_F(0^o)$ 是介质的一种属性，下面所列的即是一些常见材质的对应属性数值
![[./assets/Pasted image 20240827154914.png]]
![[./assets/Pasted image 20240827155455.png]]
![[./assets/Pasted image 20240827155524.png]]

## 8.7.2 表面粗糙度
真实世界中的反射物体往往不是理想镜面。尽管一个物体的表面看上去十分平滑，但从微观上看，它还是具有一定的 **粗糙度** 。如图 8.17 所示，我们可以认为理想镜面的粗糙度为0，它的微观表面法线都与宏观表面法线的方向相同。随着粗糙度的增加，微观表面法线的方向开始偏离宏观表面法线，由此反射光逐渐扩展为一个 **镜面瓣** 。
![[Pasted image 20241008233950.png]]
![[Pasted image 20241008235054.png]]
$$
p(\theta_h) = \cos^m(\theta_h) = \cos^m(n \cdot h)
$$
![[Pasted image 20241008235323.png]]
![[Pasted image 20241008235843.png]]
![[Pasted image 20241008235911.png]]

# 8.8 光照模型的概述
现在将之前所述的所有光照内容结合起来，即表面反射的光量相当于环境反射光、漫反射光以及镜面反射光的光量总和。
1. 环境光 $c_a$ : 模拟经表面反射的间接光量
2. 漫反射光 $c_d$ : 对进入介质内部，又经过表面下吸收而最终散射出表面的光进行模拟。由于对表面下的散射光建模比较困难，我们便假设在表面下与介质相互作用后的光从进入表面处返回，并向各个方向均匀散射
3. 镜面光 $c_s$ : 模拟经菲涅尔效应与表面粗糙度共同作用的表面反射光
据此来推导出我们在本书的着色器中实现的光照方程：
$$
\begin{aligned}
LitColor &= c_a + c_d + c_s \\
&= A_L \otimes m_d + max(L \cdot n, 0) \cdot B_L \otimes (m_d + R_F(a_h) \frac{m+8}{8}(n \cdot h)^m)
\end{aligned}
$$
设上式（8.4）中所有向量均为单位长度。
1. $L$ ：指向光源的光向量
2. $n$ ：表面法线
3. $h$ ：列于光向量与观察向量之间的中间向量
4. $A_L$ ：表示入射的环境光向量
5. $B_L$ ：表示入射的直射光向量
6. $m_d$ ：指示根据表面漫反射率而反射的入射光量
7. $L \cdot n$ ：朗博余弦定律
8. $a_h$ ：中间向量 **h** 与光向量 **L** 之间的夹角
9. $R_F(a_h)$ ：根据菲涅尔效应，关于中间向量 **h** 所反射到观察者眼中的光量
10. $m$ ：控制表面的粗糙度
11. $(n \cdot h)^m$ ：指定法线 **h** 与宏观表面法线 **n** 之间夹角为 $\theta_h$ 的所有微平面片段
12. $\frac{m+8}{8}$ ：在镜面反射过程中，为模拟能量守恒所采用的归一化因子

![[Pasted image 20241009004236.png]]

# 8.9 材质的实现
